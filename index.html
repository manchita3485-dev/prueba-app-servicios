<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Flotilla 360</title>
    <!-- 1. TailwindCSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Librería para Captura de Firma -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.0.0/signature_pad.umd.min.js"></script>
    <!-- 3. Librerías para Exportar a PDF (jsPDF y html2canvas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Estilos para las páginas */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .app-page {
            display: none;
        }
        .app-page.active {
            display: block;
        }
        /* Estilo del Canvas para firma */
        .signature-canvas {
            border: 2px dashed #ccc;
            border-radius: 8px;
            width: 100%;
            height: 150px;
            cursor: crosshair;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- 
    ============================================================
    SECCIÓN DE LOGIN (PÁGINA INICIAL)
    ============================================================
    -->
    <div id="login-page" class="page active min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <!--  -->
            <img src="https://i.imgur.com/g8cT2Wd.png" alt="Logo Empresa (Placeholder)" class="w-32 mx-auto mb-4">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Control de Flotilla 360</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition duration-300">
                    Ingresar
                </button>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
            </form>
        </div>
    </div>

    <!-- 
    ============================================================
    CONTENEDOR PRINCIPAL DE LA APLICACIÓN (OCULTO)
    ============================================================
    -->
    <div id="app-container" class="page">
        
        <!-- Barra de Navegación (Header) -->
        <nav class="bg-white shadow-md sticky top-0 z-50">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo y Título -->
                    <div class="flex items-center space-x-2">
                        <img src="https://i.imgur.com/g8cT2Wd.png" alt="Logo" class="w-10 h-10">
                        <span class="text-xl font-bold text-gray-800">Control 360</span>
                    </div>
                    
                    <!-- Menú de Navegación -->
                    <div class="hidden md:flex space-x-4">
                        <a href="#" class="nav-link text-gray-700 hover:text-blue-600 font-medium" data-page="dashboard-page">Tablero</a>
                        <a href="#" class="nav-link text-gray-700 hover:text-blue-600 font-medium" data-page="new-report-page">Nuevo Reporte 360</a>
                        <a href="#" class="nav-link text-gray-700 hover:text-blue-600 font-medium" data-page="view-reports-page">Historial (Placa/Piloto)</a>
                        <a href="#" id="admin-nav-link" class="nav-link text-red-600 hover:text-red-800 font-medium" data-page="admin-page">Admin Usuarios</a>
                    </div>
                    
                    <!-- Info de Usuario y Logout -->
                    <div class="flex items-center space-x-3">
                        <span id="current-user" class="text-sm text-gray-600"></span>
                        <button id="logout-button" class="bg-red-500 text-white px-3 py-1 rounded-md text-sm font-medium hover:bg-red-600">
                            Salir
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Contenedor de Páginas de la App -->
        <main class="container mx-auto p-4 md:p-6">

            <!-- 
            ============================================================
            PÁGINA 1: TABLERO (DASHBOARD)
            ============================================================
            -->
            <div id="dashboard-page" class="app-page active">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Tablero Principal</h1>
                
                <!-- Alertas de Servicio Vencido -->
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-6 shadow-md">
                    <h2 class="text-xl font-semibold mb-3">Alertas de Servicio Vencido</h2>
                    <div id="dashboard-alerts" class="space-y-2">
                        <!-- Las alertas se inyectarán aquí -->
                        <p class="text-gray-700">No hay vehículos con servicio vencido.</p>
                    </div>
                </div>
                
                <!-- Historial Reciente -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Inspecciones Recientes</h2>
                    <div id="dashboard-recent" class="space-y-3">
                        <!-- Reportes recientes se inyectarán aquí -->
                    </div>
                </div>
            </div>

            <!-- 
            ============================================================
            PÁGINA 2: NUEVO REPORTE 360
            ============================================================
            -->
            <div id="new-report-page" class="app-page">
                <form id="new-report-form" class="bg-white p-6 rounded-lg shadow-md">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">Check List Inspección 360 Vehícular</h1>
                    
                    <!-- Sección 1: Datos de Campaña y Vehículo -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Marca a promocionar</label>
                            <input type="text" name="marca_promocionar" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Fecha inicio (Campaña)</label>
                            <input type="date" name="fecha_inicio_campana" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Fecha finalización (Campaña)</label>
                            <input type="date" name="fecha_fin_campana" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Fecha de inspección</label>
                            <input type="date" name="fecha_inspeccion" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Vehículo</label>
                            <input type="text" name="vehiculo" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Placa</label>
                            <input type="text" name="placa" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Modelo</label>
                            <input type="text" name="modelo" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nombres y apellidos piloto</label>
                            <input type="text" name="piloto_nombre" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tipo de licencia</label>
                            <input type="text" name="piloto_licencia_tipo" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Vencimiento licencia</label>
                            <input type="date" name="piloto_licencia_venc" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tarjeta seguro</label>
                            <input type="text" name="tarjeta_seguro" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Fecha servicio anterior</label>
                            <input type="date" name="fecha_servicio_anterior" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>

                    <!-- Sección 2: Kilometraje (CRÍTICO) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
                        <div>
                            <label class="block text-sm font-medium text-blue-700">Km próximo servicio</label>
                            <input type="number" name="km_proximo_servicio" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-blue-700">Km actual</label>
                            <input type="number" name="km_actual" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                    </div>

                    <!-- Sección 3: Lista de Chequeo -->
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 mt-8 border-b pb-2">Lista de Chequeo</h2>
                    <div class="overflow-x-auto">
                        <table id="checklist-table" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ítem a Evaluar</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Buen Estado</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Mal Estado</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">N/A</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observaciones</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <!-- Items del Checklist (Basado en PDF) -->
                                <!-- NIVEL
                                ES -->
                                <tr class="bg-gray-50"><td colspan="6" class="px-6 py-2 font-semibold text-gray-700">Niveles</td></tr>
                                <tr>
                                    <td>Niveles</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Líquido refrigerante de radiador</td>
                                    <td class="text-center"><input type="radio" name="chk_niv_1" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_niv_1" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_niv_1" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_niv_1" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Niveles</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Líquido refrigerante depósito auxiliar</td>
                                    <td class="text-center"><input type="radio" name="chk_niv_2" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_niv_2" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_niv_2" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_niv_2" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Niveles</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Líquido de frenos</td>
                                    <td class="text-center"><input type="radio" name="chk_niv_3" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_niv_3" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_niv_3" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_niv_3" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Niveles</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Aceite de Motor</td>
                                    <td class="text-center"><input type="radio" name="chk_niv_4" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_niv_4" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_niv_4" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_niv_4" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Niveles</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Nivel líquido hidráulico</td>
                                    <td class="text-center"><input type="radio" name="chk_niv_5" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_niv_5" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_niv_5" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_niv_5" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Niveles</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Depósito Limpiavidrios</td>
                                    <td class="text-center"><input type="radio" name="chk_niv_6" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_niv_6" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_niv_6" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_niv_6" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <!-- PEDALES -->
                                <tr class="bg-gray-50"><td colspan="6" class="px-6 py-2 font-semibold text-gray-700">Pedales</td></tr>
                                <tr>
                                    <td>Pedales</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Acelerador (uniformidad)</td>
                                    <td class="text-center"><input type="radio" name="chk_ped_1" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_ped_1" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_ped_1" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_ped_1" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Pedales</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Embrague (clutch)</td>
                                    <td class="text-center"><input type="radio" name="chk_ped_2" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_ped_2" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_ped_2" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_ped_2" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Pedales</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Freno (agarre/firmeza)</td>
                                    <td class="text-center"><input type="radio" name="chk_ped_3" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_ped_3" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_ped_3" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_ped_3" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <!-- LUCES -->
                                <tr class="bg-gray-50"><td colspan="6" class="px-6 py-2 font-semibold text-gray-700">Luces</td></tr>
                                <tr>
                                    <td>Luces</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Luces (alta, media y baja)</td>
                                    <td class="text-center"><input type="radio" name="chk_luz_1" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_1" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_1" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_luz_1" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Luces</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Direccionales</td>
                                    <td class="text-center"><input type="radio" name="chk_luz_2" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_2" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_2" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_luz_2" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Luces</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Emergencia</td>
                                    <td class="text-center"><input type="radio" name="chk_luz_3" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_3" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_3" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_luz_3" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Luces</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Stops (freno)</td>
                                    <td class="text-center"><input type="radio" name="chk_luz_4" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_4" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_4" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_luz_4" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Luces</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Testigos de tablero</td>
                                    <td class="text-center"><input type="radio" name="chk_luz_5" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_5" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_5" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_luz_5" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Luces</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Luz reversa</td>
                                    <td class="text-center"><input type="radio" name="chk_luz_6" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_6" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_6" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_luz_6" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Luces</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Luz interna cabina</td>
                                    <td class="text-center"><input type="radio" name="chk_luz_7" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_7" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_luz_7" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_luz_7" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <!-- EQUIPO DE CARRETERA -->
                                <tr class="bg-gray-50"><td colspan="6" class="px-6 py-2 font-semibold text-gray-700">Equipo de Carretera</td></tr>
                                <tr>
                                    <td>Equipo</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Llanta de repuesto</td>
                                    <td class="text-center"><input type="radio" name="chk_eq_1" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_eq_1" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_eq_1" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_eq_1" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Equipo</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Triángulos/Conos</td>
                                    <td class="text-center"><input type="radio" name="chk_eq_2" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_eq_2" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_eq_2" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_eq_2" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Equipo</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Llave de chuchos</td>
                                    <td class="text-center"><input type="radio" name="chk_eq_3" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_eq_3" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_eq_3" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_eq_3" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Equipo</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Triquet (Gato/Jack)</td>
                                    <td class="text-center"><input type="radio" name="chk_eq_4" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_eq_4" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_eq_4" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_eq_4" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <!-- GENERAL 1 -->
                                <tr class="bg-gray-50"><td colspan="6" class="px-6 py-2 font-semibold text-gray-700">General (Componentes)</td></tr>
                                <tr>
                                    <td>General</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Llantas (presión, labor, desgaste)</td>
                                    <td class="text-center"><input type="radio" name="chk_gen_1" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_1" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_1" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_gen_1" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>General</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Batería (Bornes, corrosión)</td>
                                    <td class="text-center"><input type="radio" name="chk_gen_2" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_2" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_2" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_gen_2" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>General</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Aros (golpes o fisuras)</td>
                                    <td class="text-center"><input type="radio" name="chk_gen_3" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_3" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_3" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_gen_3" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>General</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Cinturones de Seguridad</td>
                                    <td class="text-center"><input type="radio" name="chk_gen_4" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_4" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_4" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_gen_4" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>General</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Bocina</td>
                                    <td class="text-center"><input type="radio" name="chk_gen_5" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_5" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_5" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_gen_5" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>General</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Freno de Mano (funcionalidad)</td>
                                    <td class="text-center"><input type="radio" name="chk_gen_6" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_6" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_6" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_gen_6" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>General</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Retrovisores</td>
                                    <td class="text-center"><input type="radio" name="chk_gen_7" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_7" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_7" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_gen_7" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>General</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Plumillas/Limpiabrisas</td>
                                    <td class="text-center"><input type="radio" name="chk_gen_8" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_8" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_8" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_gen_8" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>General</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Tapicería</td>
                                    <td class="text-center"><input type="radio" name="chk_gen_9" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_9" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_gen_9" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_gen_9" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <!-- AUDIO -->
                                <tr class="bg-gray-50"><td colspan="6" class="px-6 py-2 font-semibold text-gray-700">Audio (Promoción)</td></tr>
                                <tr>
                                    <td>Audio</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Amplificador (encendido)</td>
                                    <td class="text-center"><input type="radio" name="chk_aud_1" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_aud_1" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_aud_1" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_aud_1" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Audio</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Radio</td>
                                    <td class="text-center"><input type="radio" name="chk_aud_2" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_aud_2" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_aud_2" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_aud_2" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Audio</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Memoria (Spots y/o música)</td>
                                    <td class="text-center"><input type="radio" name="chk_aud_3" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_aud_3" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_aud_3" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_aud_3" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Audio</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Micrófono</td>
                                    <td class="text-center"><input type="radio" name="chk_aud_4" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_aud_4" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_aud_4" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_aud_4" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Audio</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Cable Micrófono</td>
                                    <td class="text-center"><input type="radio" name="chk_aud_5" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_aud_5" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_aud_5" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_aud_5" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Audio</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Bocinas exteriores (funcionalidad)</td>
                                    <td class="text-center"><input type="radio" name="chk_aud_6" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_aud_6" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_aud_6" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_aud_6" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <!-- IMAGEN -->
                                <tr class="bg-gray-50"><td colspan="6" class="px-6 py-2 font-semibold text-gray-700">Imagen Publicidad</td></tr>
                                <tr>
                                    <td>Imagen</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Logos de puertas</td>
                                    <td class="text-center"><input type="radio" name="chk_img_1" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_img_1" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_img_1" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_img_1" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Imagen</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Faldones</td>
                                    <td class="text-center"><input type="radio" name="chk_img_2" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_img_2" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_img_2" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_img_2" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Imagen</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Valla (ambos lados)</td>
                                    <td class="text-center"><input type="radio" name="chk_img_3" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_img_3" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_img_3" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_img_3" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                                <tr>
                                    <td>Imagen</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">Trasera camión</td>
                                    <td class="text-center"><input type="radio" name="chk_img_4" value="bueno" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_img_4" value="malo" class="h-4 w-4 text-blue-600"></td>
                                    <td class="text-center"><input type="radio" name="chk_img_4" value="na" class="h-4 w-4 text-blue-600" checked></td>
                                    <td class="px-6 py-2"><input type="text" name="obs_img_4" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Sección 4: Observaciones Adicionales -->
                    <div class="mt-8">
                        <label for="observaciones_adicionales" class="block text-sm font-medium text-gray-700">Observaciones adicionales:</label>
                        <textarea id="observaciones_adicionales" name="observaciones_adicionales" rows="4" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                    </div>

                    <!-- Sección 5: Firmas Digitales -->
                    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Firma aceptación piloto promotor:</label>
                            <canvas id="sig-piloto-canvas" class="signature-canvas bg-white"></canvas>
                            <button type="button" id="clear-sig-piloto" class="mt-2 text-sm text-blue-600 hover:text-blue-800">Limpiar Firma</button>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Firma aceptación supervisor promociones:</label>
                            <canvas id="sig-supervisor-canvas" class="signature-canvas bg-white"></canvas>
                            <button type="button" id="clear-sig-supervisor" class="mt-2 text-sm text-blue-600 hover:text-blue-800">Limpiar Firma</button>
                        </div>
                    </div>
                    
                    <!-- Botón de Guardar -->
                    <div class="mt-10 border-t pt-6 text-right">
                        <button type="submit" class="bg-green-600 text-white py-3 px-8 rounded-md font-semibold text-lg hover:bg-green-700 transition duration-300">
                            Guardar Inspección
                        </button>
                    </div>
                </form>
            </div>

            <!-- 
            ============================================================
            PÁGINA 3: HISTORIAL (VER REPORTES)
            ============================================================
            -->
            <div id="view-reports-page" class="app-page">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Historial de Inspecciones</h1>
                
                <!-- Formulario de Búsqueda -->
                <form id="search-form" class="bg-white p-6 rounded-lg shadow-md mb-6 flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full">
                        <label for="search-placa" class="block text-sm font-medium text-gray-700">Buscar por Placa:</label>
                        <input type="text" id="search-placa" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="flex-1 w-full">
                        <label for="search-piloto" class="block text-sm font-medium text-gray-700">Buscar por Piloto:</label>
                        <input type="text" id="search-piloto" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <button type="submit" class="w-full md:w-auto bg-blue-600 text-white py-2 px-6 rounded-md font-semibold hover:bg-blue-700 transition duration-300">
                        Buscar
                    </button>
                </form>

                <!-- Contenedor de Resultados -->
                <div id="search-results-container" class="bg-white p-6 rounded-lg shadow-md">
                    <p class="text-gray-500">Ingrese un término de búsqueda para ver los reportes.</p>
                    <!-- Los resultados de la búsqueda se inyectarán aquí -->
                </div>
            </div>

            <!-- 
            ============================================================
            PÁGINA 4: DETALLE DE REPORTE (PARA VER Y EXPORTAR A PDF)
            ============================================================
            -->
            <div id="report-detail-page" class="app-page">
                <div class="mb-6 flex justify-between items-center">
                    <button id="back-to-search-btn" class="text-blue-600 hover:text-blue-800 font-medium">&larr; Volver a la búsqueda</button>
                    <div>
                        <button id="delete-report-btn" data-report-id="" class="bg-red-600 text-white py-2 px-5 rounded-md font-semibold hover:bg-red-700 transition duration-300">
                            Eliminar Reporte
                        </button>
                        <button id="export-pdf-btn" class="bg-green-600 text-white py-2 px-5 rounded-md font-semibold hover:bg-green-700 transition duration-300">
                            Exportar a PDF
                        </button>
                    </div>
                </div>

                <!-- 
                Contenedor del PDF (Tamaño Carta: 8.5in x 11in). 
                Usamos 'w-[8.5in]' para forzar el ancho.
                'html2canvas' capturará este DIV.
                -->
                <div id="pdf-content-wrapper" class="mx-auto max-w-4xl">
                    <div id="pdf-content" class="bg-white p-10 shadow-xl w-[8.5in] min-h-[11in] mx-auto">
                        <!-- El contenido detallado del reporte se inyectará aquí -->
                    </div>
                </div>
            </div>


            <!-- 
            ============================================================
            PÁGINA 5: PANEL DE ADMINISTRACIÓN (SOLO ADMIN)
            ============================================================
            -->
            <div id="admin-page" class="app-page">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Panel de Administración</h1>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Crear Nuevo Usuario -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Crear Nuevo Usuario</h2>
                        <form id="create-user-form">
                            <div class="mb-4">
                                <label for="new-username" class="block text-sm font-medium text-gray-700">Nuevo Usuario</label>
                                <input type="text" id="new-username" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div class="mb-4">
                                <label for="new-password" class="block text-sm font-medium text-gray-700">Nueva Contraseña</label>
                                <input type="password" id="new-password" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div class="mb-6">
                                <label for="new-role" class="block text-sm font-medium text-gray-700">Rol</label>
                                <select id="new-role" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white">
                                    <option value="invitado">Invitado</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition duration-300">
                                Crear Usuario
                            </button>
                            <p id="admin-success" class="text-green-600 text-sm mt-4"></p>
                        </form>
                    </div>

                    <!-- Lista de Usuarios -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Usuarios Existentes</h2>
                        <ul id="user-list" class="space-y-3">
                            <!-- Los usuarios se inyectarán aquí -->
                        </ul>
                    </div>
                </div>
            </div>

        </main>
    </div>


    <!-- 
    ============================================================
    ============================================================
    SCRIPT PRINCIPAL DE LA APLICACIÓN
    ============================================================
    ============================================================
    -->
    <script>
        window.onload = () => {

            // Inicializar librerías PDF
            const { jsPDF } = window.jspdf;
            const h2c = window.html2canvas;

            // Inicializar pads de firma (se activarán al mostrar la página)
            let sigPilotoPad, sigSupervisorPad;

            // --- Objeto Principal de la App ---
            const App = {
                // --- Base de Datos (Simulada con localStorage) ---
                db: {
                    users: [],
                    reports: []
                },
                currentUser: null,
                currentPage: 'login-page',

                // --- Inicialización ---
                init() {
                    this.loadData();
                    this.initLogin();
                    this.initNavigation();
                    this.initForms();
                    this.initSignaturePads();

                    if (this.db.users.length === 0) {
                        // Crear admin por defecto si la BD está vacía
                        this.db.users.push({ id: 1, user: 'admin', pass: 'admin', role: 'admin' });
                        this.saveData();
                        console.log('Admin por defecto creado: admin / admin');
                    }
                },

                // --- Gestión de Datos (localStorage) ---
                loadData() {
                    const users = localStorage.getItem('control360_users');
                    const reports = localStorage.getItem('control360_reports');
                    if (users) this.db.users = JSON.parse(users);
                    if (reports) this.db.reports = JSON.parse(reports);
                },
                saveData() {
                    localStorage.setItem('control360_users', JSON.stringify(this.db.users));
                    localStorage.setItem('control360_reports', JSON.stringify(this.db.reports));
                },

                // --- Autenticación y Navegación ---
                initLogin() {
                    const loginForm = document.getElementById('login-form');
                    const logoutBtn = document.getElementById('logout-button');
                    const loginError = document.getElementById('login-error');

                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const user = document.getElementById('username').value;
                        const pass = document.getElementById('password').value;
                        
                        const foundUser = this.db.users.find(u => u.user === user && u.pass === pass);
                        
                        if (foundUser) {
                            this.currentUser = foundUser;
                            this.navigate('app-container');
                            this.navigateApp('dashboard-page');
                            this.setupUIForUser();
                            loginError.textContent = '';
                            document.getElementById('username').value = '';
                            document.getElementById('password').value = '';
                        } else {
                            loginError.textContent = 'Usuario o contraseña incorrectos.';
                        }
                    });

                    logoutBtn.addEventListener('click', () => {
                        this.currentUser = null;
                        this.navigate('login-page');
                    });
                },
                
                setupUIForUser() {
                    const userSpan = document.getElementById('current-user');
                    const adminLink = document.getElementById('admin-nav-link');
                    if (this.currentUser) {
                        userSpan.textContent = `Usuario: ${this.currentUser.user} (${this.currentUser.role})`;
                        if (this.currentUser.role === 'admin') {
                            adminLink.style.display = 'block';
                        } else {
                            adminLink.style.display = 'none';
                        }
                    }
                },

                initNavigation() {
                    const navLinks = document.querySelectorAll('.nav-link');
                    navLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const pageId = e.target.getAttribute('data-page');
                            this.navigateApp(pageId);
                        });
                    });

                    document.getElementById('back-to-search-btn').addEventListener('click', () => {
                        this.navigateApp('view-reports-page');
                    });
                },

                navigate(pageId) {
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    document.getElementById(pageId).classList.add('active');
                    this.currentPage = pageId;
                },

                navigateApp(pageId) {
                    document.querySelectorAll('.app-page').forEach(page => {
                        page.classList.remove('active');
                    });
                    document.getElementById(pageId).classList.add('active');

                    // Lógica específica al cargar una página
                    if (pageId === 'dashboard-page') this.renderDashboard();
                    if (pageId === 'admin-page') this.renderAdminPanel();
                    if (pageId === 'new-report-page') this.resetNewReportForm();
                    if (pageId === 'view-reports-page') this.resetSearchPage();
                },

                // --- Lógica del Tablero (Dashboard) ---
                renderDashboard() {
                    const alertsContainer = document.getElementById('dashboard-alerts');
                    const recentContainer = document.getElementById('dashboard-recent');
                    
                    alertsContainer.innerHTML = '';
                    recentContainer.innerHTML = '';

                    let overdueFound = false;
                    const sortedReports = [...this.db.reports].sort((a, b) => new Date(b.header.fecha_inspeccion) - new Date(a.header.fecha_inspeccion));

                    // 1. Verificar servicios vencidos
                    // Usamos un Map para solo obtener el último reporte de cada placa
                    const lastReportByPlaca = new Map();
                    for (const report of sortedReports) {
                        if (!lastReportByPlaca.has(report.header.placa)) {
                            lastReportByPlaca.set(report.header.placa, report);
                        }
                    }
                    
                    lastReportByPlaca.forEach(report => {
                        const kmActual = parseFloat(report.header.km_actual);
                        const kmProximo = parseFloat(report.header.km_proximo_servicio);
                        
                        if (kmActual > kmProximo) {
                            overdueFound = true;
                            const kmDiff = (kmActual - kmProximo).toLocaleString('es-GT');
                            alertsContainer.innerHTML += `
                                <div class="p-3 bg-red-200 rounded-md shadow-sm">
                                    <p class="font-semibold text-red-800">Placa: ${report.header.placa}</p>
                                    <p class="text-sm text-red-700">Piloto: ${report.header.piloto_nombre}</p>
                                    <p class="text-sm text-red-700">Excedido por: ${kmDiff} km (Actual: ${kmActual.toLocaleString('es-GT')} km)</p>
                                </div>
                            `;
                        }
                    });

                    if (!overdueFound) {
                        alertsContainer.innerHTML = '<p class="text-gray-700">No hay vehículos con servicio vencido.</p>';
                    }

                    // 2. Mostrar reportes recientes
                    const recent = sortedReports.slice(0, 5);
                    if (recent.length === 0) {
                        recentContainer.innerHTML = '<p class="text-gray-500">No hay inspecciones recientes.</p>';
                    } else {
                        recent.forEach(report => {
                            recentContainer.innerHTML += `
                                <div class="p-4 border border-gray-200 rounded-md hover:bg-gray-50 transition">
                                    <div class="flex justify-between items-center">
                                        <p class="font-semibold text-blue-600">${report.header.placa} - ${report.header.piloto_nombre}</p>
                                        <span class="text-sm text-gray-500">${new Date(report.header.fecha_inspeccion).toLocaleDateString('es-GT')}</span>
                                    </div>
                                    <p class="text-sm text-gray-600">Vehículo: ${report.header.vehiculo} ${report.header.modelo}</p>
                                </div>
                            `;
                        });
                    }
                },

                // --- Lógica de Formularios ---
                initForms() {
                    // 1. Formulario de Nuevo Reporte
                    document.getElementById('new-report-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        if (sigPilotoPad.isEmpty() || sigSupervisorPad.isEmpty()) {
                            alert('Se requieren ambas firmas (Piloto y Supervisor) para guardar el reporte.');
                            return;
                        }
                        this.handleNewReportSubmit();
                    });

                    // 2. Formulario de Búsqueda
                    document.getElementById('search-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleReportSearch();
                    });

                    // 3. Formulario de Admin (Crear Usuario)
                    document.getElementById('create-user-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleCreateUser();
                    });
                },

                // --- Lógica de Firmas ---
                initSignaturePads() {
                    const pilCanvas = document.getElementById('sig-piloto-canvas');
                    const supCanvas = document.getElementById('sig-supervisor-canvas');
                    
                    // Ajustar el tamaño del canvas para alta resolución
                    const resizeCanvas = (canvas) => {
                        const ratio = Math.max(window.devicePixelRatio || 1, 1);
                        canvas.width = canvas.offsetWidth * ratio;
                        canvas.height = canvas.offsetHeight * ratio;
                        canvas.getContext("2d").scale(ratio, ratio);
                    };
                    
                    resizeCanvas(pilCanvas);
                    resizeCanvas(supCanvas);

                    sigPilotoPad = new SignaturePad(pilCanvas);
                    sigSupervisorPad = new SignaturePad(supCanvas);
                    
                    document.getElementById('clear-sig-piloto').addEventListener('click', () => sigPilotoPad.clear());
                    document.getElementById('clear-sig-supervisor').addEventListener('click', () => sigSupervisorPad.clear());
                },

                resetNewReportForm() {
                    document.getElementById('new-report-form').reset();
                    if (sigPilotoPad) sigPilotoPad.clear();
                    if (sigSupervisorPad) sigSupervisorPad.clear();
                },

                // --- Lógica de Reportes ---
                handleNewReportSubmit() {
                    const form = document.getElementById('new-report-form');
                    const formData = new FormData(form);
                    const report = {
                        id: `rep_${new Date().getTime()}`, // ID único
                        header: {},
                        checklist: [],
                        observaciones: '',
                        signatures: {}
                    };

                    // 1. Capturar Header
                    const headerFields = ['marca_promocionar', 'fecha_inicio_campana', 'fecha_fin_campana', 'fecha_inspeccion', 'vehiculo', 'placa', 'modelo', 'piloto_nombre', 'piloto_licencia_tipo', 'piloto_licencia_venc', 'tarjeta_seguro', 'fecha_servicio_anterior', 'km_proximo_servicio', 'km_actual'];
                    for (const field of headerFields) {
                        report.header[field] = formData.get(field);
                    }
                    
                    // 2. Capturar Checklist
                    const tableRows = document.querySelectorAll('#checklist-table tbody tr');
                    tableRows.forEach(row => {
                        if (row.children.length < 6) return; // Omitir filas de categoría
                        
                        const category = row.children[0].textContent;
                        const item = row.children[1].textContent;
                        const radioName = row.querySelector('input[type="radio"]').name;
                        const status = formData.get(radioName);
                        const observationName = row.querySelector('input[type="text"]').name;
                        const observation = formData.get(observationName);
                        
                        report.checklist.push({ category, item, status, observation });
                    });

                    // 3. Capturar Observaciones Adicionales
                    report.observaciones = formData.get('observaciones_adicionales');
                    
                    // 4. Capturar Firmas (como imagen Base64)
                    report.signatures = {
                        piloto: sigPilotoPad.toDataURL('image/png'),
                        supervisor: sigSupervisorPad.toDataURL('image/png')
                    };

                    // 5. Guardar
                    this.db.reports.push(report);
                    this.saveData();

                    alert('¡Inspección guardada con éxito!');
                    this.resetNewReportForm();
                    this.navigateApp('dashboard-page');
                },

                handleReportSearch() {
                    const placa = document.getElementById('search-placa').value.toLowerCase().trim();
                    const piloto = document.getElementById('search-piloto').value.toLowerCase().trim();
                    const resultsContainer = document.getElementById('search-results-container');
                    
                    if (!placa && !piloto) {
                        resultsContainer.innerHTML = '<p class="text-gray-500">Debe ingresar al menos una placa o un nombre de piloto.</p>';
                        return;
                    }

                    const results = this.db.reports.filter(report => {
                        const placaMatch = placa ? report.header.placa.toLowerCase().includes(placa) : false;
                        const pilotoMatch = piloto ? report.header.piloto_nombre.toLowerCase().includes(piloto) : false;
                        return placaMatch || pilotoMatch;
                    }).sort((a, b) => new Date(b.header.fecha_inspeccion) - new Date(a.header.fecha_inspeccion));

                    if (results.length === 0) {
                        resultsContainer.innerHTML = '<p class="text-gray-500">No se encontraron reportes con esos criterios.</p>';
                    } else {
                        resultsContainer.innerHTML = results.map(report => `
                            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                                <div>
                                    <p class="font-semibold text-blue-600">${report.header.placa} - ${report.header.piloto_nombre}</p>
                                    <p class="text-sm text-gray-600">Fecha: ${new Date(report.header.fecha_inspeccion).toLocaleDateString('es-GT')}</p>
                                </div>
                                <button class="view-report-btn bg-blue-500 text-white px-4 py-1 rounded-md text-sm hover:bg-blue-600" data-report-id="${report.id}">
                                    Ver Detalle
                                </button>
                            </div>
                        `).join('');

                        // Añadir listeners a los botones de "Ver Detalle"
                        document.querySelectorAll('.view-report-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const reportId = e.target.getAttribute('data-report-id');
                                this.renderReportDetail(reportId);
                            });
                        });
                    }
                },
                
                resetSearchPage() {
                    document.getElementById('search-form').reset();
                    document.getElementById('search-results-container').innerHTML = '<p class="text-gray-500">Ingrese un término de búsqueda para ver los reportes.</p>';
                },

                renderReportDetail(reportId) {
                    const report = this.db.reports.find(r => r.id === reportId);
                    if (!report) return;

                    const container = document.getElementById('pdf-content');
                    
                    // Asignar ID al botón de eliminar (si es admin)
                    const deleteBtn = document.getElementById('delete-report-btn');
                    if (this.currentUser.role === 'admin') {
                        deleteBtn.style.display = 'inline-block';
                        deleteBtn.setAttribute('data-report-id', reportId);
                        // Remover listener anterior y añadir nuevo
                        deleteBtn.replaceWith(deleteBtn.cloneNode(true));
                        document.getElementById('delete-report-btn').addEventListener('click', () => this.handleDeleteReport(reportId));
                    } else {
                        deleteBtn.style.display = 'none';
                    }

                    // Asignar ID al botón de PDF
                    const pdfBtn = document.getElementById('export-pdf-btn');
                    pdfBtn.setAttribute('data-report-id', reportId);
                    // Remover listener anterior y añadir nuevo
                    pdfBtn.replaceWith(pdfBtn.cloneNode(true));
                    document.getElementById('export-pdf-btn').addEventListener('click', () => this.handleGeneratePDF(reportId));


                    // --- Construir el HTML del Reporte ---
                    // Helper para formatear estado
                    const formatStatus = (status) => {
                        if (status === 'bueno') return '<span class="font-bold text-green-600">BUENO</span>';
                        if (status === 'malo') return '<span class="font-bold text-red-600">MALO</span>';
                        return '<span class="text-gray-500">N/A</span>';
                    };

                    // 1. Header
                    let headerHtml = `
                        <div class="flex justify-between items-start mb-6 border-b-2 border-gray-800 pb-4">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900">Inspección 360 Vehícular</h1>
                                <p class="text-lg text-gray-700">Placa: <span class="font-semibold">${report.header.placa}</span></p>
                                <p class="text-lg text-gray-700">Piloto: <span class="font-semibold">${report.header.piloto_nombre}</span></p>
                            </div>
                            <img src="https://i.imgur.com/g8cT2Wd.png" alt="Logo" class="w-32">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-x-6 gap-y-3 text-sm mb-6">
                            <p><strong>Fecha Inspección:</strong> ${new Date(report.header.fecha_inspeccion).toLocaleDateString('es-GT')}</p>
                            <p><strong>Vehículo:</strong> ${report.header.vehiculo}</p>
                            <p><strong>Modelo:</strong> ${report.header.modelo}</p>
                            <p><strong>Licencia:</strong> ${report.header.piloto_licencia_tipo}</p>
                            <p><strong>Vencimiento:</strong> ${new Date(report.header.piloto_licencia_venc).toLocaleDateString('es-GT')}</p>
                            <p><strong>Seguro:</strong> ${report.header.tarjeta_seguro}</p>
                            <p><strong>Marca (Campaña):</strong> ${report.header.marca_promocionar}</p>
                            <p><strong>Inicio Campaña:</strong> ${new Date(report.header.fecha_inicio_campana).toLocaleDateString('es-GT')}</p>
                            <p><strong>Fin Campaña:</strong> ${new Date(report.header.fecha_fin_campana).toLocaleDateString('es-GT')}</p>
                        </div>
                    `;

                    // 2. Alerta de Kilometraje
                    const kmActual = parseFloat(report.header.km_actual);
                    const kmProximo = parseFloat(report.header.km_proximo_servicio);
                    if (kmActual > kmProximo) {
                        headerHtml += `
                            <div class="border-4 border-red-600 p-4 mb-6 bg-red-100">
                                <h3 class="text-xl font-bold text-red-700 text-center">¡SERVICIO VENCIDO!</h3>
                                <p class="text-center text-red-600">Excedido por <strong>${(kmActual - kmProximo).toLocaleString('es-GT')} km</strong>.</p>
                            </div>
                        `;
                    }
                    
                    headerHtml += `
                        <div class="grid grid-cols-3 gap-6 mb-6 text-center">
                            <div class="p-3 bg-gray-100 rounded">
                                <p class="text-xs font-bold text-gray-600 uppercase">Servicio Anterior</p>
                                <p class="text-lg font-semibold">${new Date(report.header.fecha_servicio_anterior).toLocaleDateString('es-GT')}</p>
                            </div>
                            <div class="p-3 bg-blue-100 rounded">
                                <p class="text-xs font-bold text-blue-700 uppercase">Km Próximo Servicio</p>
                                <p class="text-lg font-semibold">${kmProximo.toLocaleString('es-GT')} km</p>
                            </div>
                            <div class="p-3 ${kmActual > kmProximo ? 'bg-red-100' : 'bg-green-100'} rounded">
                                <p class="text-xs font-bold ${kmActual > kmProximo ? 'text-red-700' : 'text-green-700'} uppercase">Km Actual</p>
                                <p class="text-lg font-semibold">${kmActual.toLocaleString('es-GT')} km</p>
                            </div>
                        </div>
                    `;

                    // 3. Checklist
                    let checklistHtml = `
                        <h2 class="text-xl font-bold text-gray-800 mb-4 mt-8 border-b pb-2">Resultados de la Inspección</h2>
                        <table class="w-full text-sm border-collapse border border-gray-300">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-300 p-2 text-left">Ítem</th>
                                    <th class="border border-gray-300 p-2 text-center">Estado</th>
                                    <th class="border border-gray-300 p-2 text-left">Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    let currentCategory = '';
                    report.checklist.forEach(item => {
                        if (item.category !== currentCategory) {
                            currentCategory = item.category;
                            checklistHtml += `
                                <tr class="bg-gray-50">
                                    <td colspan="3" class="border border-gray-300 p-2 font-semibold text-gray-700">${currentCategory}</td>
                                </tr>
                            `;
                        }
                        checklistHtml += `
                            <tr>
                                <td class="border border-gray-300 p-2">${item.item}</td>
                                <td class="border border-gray-300 p-2 text-center">${formatStatus(item.status)}</td>
                                <td class="border border-gray-300 p-2">${item.observation || '---'}</td>
                            </tr>
                        `;
                    });
                    checklistHtml += '</tbody></table>';

                    // 4. Observaciones y Firmas
                    let footerHtml = `
                        <div class="mt-8">
                            <h3 class="text-lg font-semibold text-gray-800">Observaciones Adicionales:</h3>
                            <p class="text-sm p-3 bg-gray-50 border rounded-md min-h-[50px] mt-2">${report.observaciones || '---'}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-8 mt-10 pt-6 border-t-2 border-gray-300">
                            <div>
                                <h3 class="text-md font-semibold text-gray-800">Firma Piloto Promotor:</h3>
                                <p class="text-sm mb-2">${report.header.piloto_nombre}</p>
                                <img src="${report.signatures.piloto}" alt="Firma Piloto" class="w-full border border-gray-400 rounded-md">
                            </div>
                            <div>
                                <h3 class="text-md font-semibold text-gray-800">Firma Supervisor Promociones:</h3>
                                <p class="text-sm mb-2">${this.currentUser.user}</p>
                                <img src="${report.signatures.supervisor}" alt="Firma Supervisor" class="w-full border border-gray-400 rounded-md">
                            </div>
                        </div>
                    `;

                    // Unir todo y mostrar
                    container.innerHTML = headerHtml + checklistHtml + footerHtml;
                    this.navigateApp('report-detail-page');
                },
                
                handleDeleteReport(reportId) {
                    if (this.currentUser.role !== 'admin') {
                        alert('Acción no permitida.');
                        return;
                    }
                    if (confirm(`¿Está seguro que desea eliminar el reporte ${reportId}? Esta acción no se puede deshacer.`)) {
                        this.db.reports = this.db.reports.filter(r => r.id !== reportId);
                        this.saveData();
                        alert('Reporte eliminado.');
                        this.navigateApp('view-reports-page');
                        this.resetSearchPage();
                    }
                },

                handleGeneratePDF(reportId) {
                    const report = this.db.reports.find(r => r.id === reportId);
                    const content = document.getElementById("pdf-content");
                    const btnContainer = document.querySelector("#report-detail-page > div:first-child");

                    // Ocultar botones para que no salgan en la "foto"
                    btnContainer.style.display = 'none';

                    h2c(content, {
                        scale: 2, // Aumentar la escala para mejor resolución
                        useCORS: true
                    }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        
                        // Crear PDF en tamaño CARTA (Letter)
                        // Ancho: 8.5in, Alto: 11in
                        const pdf = new jsPDF({
                            orientation: 'portrait',
                            unit: 'in',
                            format: 'letter'
                        });

                        const pdfWidth = pdf.internal.pageSize.getWidth(); // 8.5
                        const pdfHeight = pdf.internal.pageSize.getHeight(); // 11
                        
                        // Relación de aspecto del canvas
                        const canvasWidth = canvas.width;
                        const canvasHeight = canvas.height;
                        const canvasRatio = canvasHeight / canvasWidth;

                        // Calcular la altura de la imagen en el PDF para que quepa en el ancho
                        let imgHeight = pdfWidth * canvasRatio;
                        let heightLeft = imgHeight;
                        
                        let position = 0; // Posición Y en el PDF

                        // Añadir la primera página
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                        heightLeft -= pdfHeight;

                        // Añadir más páginas si el contenido es más largo que 11 pulgadas
                        while (heightLeft > 0) {
                            position = heightLeft - imgHeight; // Mover la imagen "hacia arriba"
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                            heightLeft -= pdfHeight;
                        }

                        // Guardar el PDF
                        pdf.save(`Reporte_360_${report.header.placa}_${report.header.fecha_inspeccion}.pdf`);
                        
                        // Volver a mostrar los botones
                        btnContainer.style.display = 'flex';
                    }).catch(err => {
                        console.error("Error al generar PDF:", err);
                        btnContainer.style.display = 'flex';
                    });
                },

                // --- Lógica de Administración ---
                renderAdminPanel() {
                    const userList = document.getElementById('user-list');
                    userList.innerHTML = '';
                    
                    if (this.currentUser.role !== 'admin') {
                        this.navigateApp('dashboard-page');
                        return;
                    }

                    this.db.users.forEach(user => {
                        userList.innerHTML += `
                            <li class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                                <div>
                                    <p class="font-semibold text-gray-800">${user.user}</p>
                                    <p class="text-sm text-gray-500">${user.role}</p>
                                </div>
                                ${user.user !== 'admin' ? 
                                    `<button class="delete-user-btn text-red-500 hover:text-red-700 text-sm" data-user-id="${user.id}">Eliminar</button>` : 
                                    '<span class="text-sm text-gray-400">Sistema</span>'}
                            </li>
                        `;
                    });

                    // Listeners para botones de eliminar
                    document.querySelectorAll('.delete-user-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const userId = parseInt(e.target.getAttribute('data-user-id'));
                            this.handleDeleteUser(userId);
                        });
                    });
                },

                handleCreateUser() {
                    const user = document.getElementById('new-username').value;
                    const pass = document.getElementById('new-password').value;
                    const role = document.getElementById('new-role').value;
                    const successMsg = document.getElementById('admin-success');
                    
                    if (!user || !pass) {
                        alert('Usuario y Contraseña son requeridos.');
                        return;
                    }
                    
                    const userExists = this.db.users.find(u => u.user === user);
                    if (userExists) {
                        alert('Ese nombre de usuario ya existe.');
                        return;
                    }

                    const newId = this.db.users.length > 0 ? Math.max(...this.db.users.map(u => u.id)) + 1 : 1;
                    this.db.users.push({ id: newId, user, pass, role });
                    this.saveData();
                    
                    successMsg.textContent = `¡Usuario "${user}" creado con éxito!`;
                    document.getElementById('create-user-form').reset();
                    this.renderAdminPanel();
                    
                    setTimeout(() => successMsg.textContent = '', 3000);
                },

                handleDeleteUser(userId) {
                    if (confirm('¿Está seguro que desea eliminar este usuario?')) {
                        this.db.users = this.db.users.filter(u => u.id !== userId);
                        this.saveData();
                        this.renderAdminPanel();
                    }
                }
            };

            // --- Iniciar la Aplicación ---
            App.init();

        };
    </script>

</body>
</html>

